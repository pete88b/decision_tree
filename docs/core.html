---

title: core

keywords: fastai
sidebar: home_sidebar

summary: "Low level utilities."
description: "Low level utilities."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utilities">Utilities<a class="anchor-link" href="#Utilities"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">split_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_array" class="doc_header"><code>split_array</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L9" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_array</code>(<strong><code>data</code></strong>, <strong><code>idx</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="r3" class="doc_header"><code>r3</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L12" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>r3</code>(<strong><code>x</code></strong>)</p>
</blockquote>
<p>return a scalar value rounded to 3dp or the values of iterable, rounded to 3dp in a new array/tuple</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_in</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.02</span><span class="p">,</span> <span class="mf">3.003</span><span class="p">,</span> <span class="mf">4.0004</span><span class="p">]</span>
<span class="n">test_result</span> <span class="o">=</span> <span class="n">r3</span><span class="p">(</span><span class="n">test_in</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">test_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">test_result</span>
<span class="k">assert</span> <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.02</span><span class="p">,</span> <span class="mf">3.003</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_result</span>
<span class="n">test_in</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">test_in</span><span class="p">)</span>
<span class="n">test_result</span> <span class="o">=</span> <span class="n">r3</span><span class="p">(</span><span class="n">test_in</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">test_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">test_result</span>
<span class="k">assert</span> <span class="p">(</span><span class="mf">3.3</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.02</span><span class="p">,</span> <span class="mf">3.003</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">==</span> <span class="n">test_result</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For efficiency, we need to be able to calculate standard deviations without processing all data with <code>np.std</code>.</p>
<p>By keeping track of;</p>
<ul>
<li>count of items <code>c</code></li>
<li>sum of items <code>s</code></li>
<li>sum of items squared <code>s2</code></li>
</ul>
<p>we can calculate variance with; <code>(s2/c) - (s/c)**2</code></p>
<p>Note: we have to clamp <code>var</code> at zero. When working with small numbers, they sometimes end up -ve due to numerical instability.
It might be interesting to do a moving average implementation like: <a href="https://github.com/pete88b/data-science/blob/master/pytorch-things/calculating-variance.ipynb">https://github.com/pete88b/data-science/blob/master/pytorch-things/calculating-variance.ipynb</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Aggs" class="doc_header"><code>class</code> <code>Aggs</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L31" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Aggs</code>(<strong><code>y</code></strong>)</p>
</blockquote>
<p>keeps track of <code>c</code>, <code>s</code> and <code>s2</code> and provides access to <code>score</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Aggs.__init__" class="doc_header"><code>Aggs.__init__</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L33" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Aggs.__init__</code>(<strong><code>y</code></strong>)</p>
</blockquote>
<p>create a new <a href="/decision_tree/core#Aggs"><code>Aggs</code></a> assuming you're going to iterate over <code>y</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Aggs.upd" class="doc_header"><code>Aggs.upd</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Aggs.upd</code>(<strong><code>yi</code></strong>)</p>
</blockquote>
<p>update <code>c</code>, <code>s</code> and <code>s2</code> values with the next <code>y</code> value</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Aggs.score" class="doc_header"><code>Aggs.score</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Aggs.score</code>()</p>
</blockquote>
<p>return the sum of the standard deviation for both sides of <code>y</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">np_score</span><span class="p">(</span><span class="n">y</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">aggs</span> <span class="o">=</span> <span class="n">Aggs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">aggs</span><span class="o">.</span><span class="n">_c</span> <span class="o">==</span> <span class="mi">11</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> 
    <span class="n">aggs</span><span class="o">.</span><span class="n">upd</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">y_le</span><span class="p">,</span> <span class="n">y_gt</span> <span class="o">=</span> <span class="n">split_array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_le</span><span class="p">)</span> <span class="o">==</span> <span class="n">aggs</span><span class="o">.</span><span class="n">c</span>
    <span class="k">assert</span> <span class="n">r3</span><span class="p">(</span><span class="n">aggs</span><span class="o">.</span><span class="n">score</span><span class="p">())</span> <span class="o">==</span> <span class="n">r3</span><span class="p">(</span><span class="n">np_score</span><span class="p">(</span><span class="n">y_le</span><span class="p">)</span> <span class="o">+</span> <span class="n">np_score</span><span class="p">(</span><span class="n">y_gt</span><span class="p">))</span>
<span class="k">assert</span> <span class="mf">14.361</span> <span class="o">==</span> <span class="n">r3</span><span class="p">(</span><span class="n">aggs</span><span class="o">.</span><span class="n">score</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loss-Functions">Loss Functions<a class="anchor-link" href="#Loss-Functions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mse" class="doc_header"><code>mse</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L49" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mse</code>(<strong><code>x</code></strong>, <strong><code>y</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rmse" class="doc_header"><code>rmse</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/core.py#L50" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rmse</code>(<strong><code>x</code></strong>, <strong><code>y</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.778</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.556</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.332</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.115</span><span class="p">,</span> <span class="mf">0.119</span><span class="p">,</span>  <span class="mf">0.331</span><span class="p">,</span>  <span class="mf">0.556</span><span class="p">,</span>  <span class="mf">0.777</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.721</span><span class="p">,</span>  <span class="mf">0.036</span><span class="p">,</span>  <span class="mf">0.366</span><span class="p">,</span>  <span class="mf">0.490</span><span class="p">,</span>  <span class="mf">0.565</span><span class="p">,</span> <span class="mf">1.080</span><span class="p">,</span> <span class="mf">0.414</span><span class="p">,</span> <span class="mf">1.125</span><span class="p">,</span> <span class="mf">1.483</span><span class="p">,</span> <span class="mf">1.569</span><span class="p">])</span>
<span class="k">assert</span> <span class="mf">0.480</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">assert</span> <span class="mf">0.693</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rmse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># expect 0.6931791254791217</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

