---

title: Models

keywords: fastai
sidebar: home_sidebar

summary: "Tree ensemble and decision tree models."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 20_models.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Decision-Tree">Decision Tree<a class="anchor-link" href="#Decision-Tree">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Node" class="doc_header"><code>class</code> <code>Node</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/models.py#L11" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Node</code>(<strong><code>depth</code></strong>, <strong><code>pred</code></strong>, <strong><code>sample_idxs</code></strong>, <strong><code>split_score</code></strong>=<em><code>inf</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">==</span> <span class="n">Node</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">split_score</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="best_split_for_col" class="doc_header"><code>best_split_for_col</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/models.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>best_split_for_col</code>(<strong><code>data</code></strong>, <strong><code>node</code></strong>, <strong><code>col_idx</code></strong>, <strong><code>min_leaf_samples</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Returns the best split that can be made for this column/node</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[[</span><span class="mf">23.2</span><span class="p">,</span> <span class="mf">44.4</span><span class="p">],</span> <span class="c1">#0</span>
     <span class="p">[</span> <span class="mf">2.</span> <span class="p">,</span>  <span class="mf">2.</span> <span class="p">],</span> <span class="c1">#1</span>
     <span class="p">[</span><span class="mf">34.3</span><span class="p">,</span> <span class="mf">77.3</span><span class="p">],</span> <span class="c1">#2</span>
     <span class="p">[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="c1">#3</span>
     <span class="p">[</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="mf">1.5</span><span class="p">],</span> <span class="c1">#4</span>
     <span class="p">[</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="mf">9.2</span><span class="p">],</span> <span class="c1">#5</span>
     <span class="p">[</span> <span class="mf">2.</span> <span class="p">,</span> <span class="o">-</span><span class="mf">2.</span> <span class="p">]])</span><span class="c1">#6</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.6</span><span class="p">])</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">DataWrapper</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_x</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">test_y</span><span class="p">))</span>

<span class="n">test_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<span class="n">best_split_for_col</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">le_split</span><span class="p">,</span> <span class="n">gt_split</span> <span class="o">=</span> <span class="n">test_node</span><span class="o">.</span><span class="n">split_idxs</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">test_y</span><span class="p">[</span><span class="n">le_split</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">test_y</span><span class="p">[</span><span class="n">gt_split</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">6.6</span><span class="p">,</span> <span class="mf">0.</span> <span class="p">,</span> <span class="mf">2.2</span><span class="p">])</span>

<span class="n">test_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<span class="n">best_split_for_col</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">le_split</span><span class="p">,</span> <span class="n">gt_split</span> <span class="o">=</span> <span class="n">test_node</span><span class="o">.</span><span class="n">split_idxs</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">test_y</span><span class="p">[</span><span class="n">le_split</span><span class="p">],</span> <span class="p">[</span><span class="mf">6.6</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">test_y</span><span class="p">[</span><span class="n">gt_split</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">0.</span> <span class="p">,</span> <span class="mf">2.2</span><span class="p">])</span>

<span class="c1"># not enough data to split with at least 4 values in each leaf</span>
<span class="n">test_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<span class="n">best_split_for_col</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">test_node</span><span class="o">.</span><span class="n">split_score</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="n">test_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">)[</span><span class="mi">4</span><span class="p">:])</span>
<span class="n">test_split</span> <span class="o">=</span> <span class="n">best_split_for_col</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">le_split</span><span class="p">,</span> <span class="n">gt_split</span> <span class="o">=</span> <span class="n">test_node</span><span class="o">.</span><span class="n">split_idxs</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">test_y</span><span class="p">[</span><span class="n">le_split</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.4</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">test_y</span><span class="p">[</span><span class="n">gt_split</span><span class="p">],</span> <span class="p">[</span><span class="mf">6.6</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">test_node</span><span class="o">.</span><span class="n">split_values</span> <span class="o">==</span> <span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-7-4c94206e40a2&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span>      [ 2. , -2. ]])#6
<span class="ansi-green-intense-fg ansi-bold">      9</span> test_y <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0.0</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1.1</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">2.2</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">3.3</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">4.4</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">5.5</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">6.6</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 10</span><span class="ansi-red-fg"> </span>test_data <span class="ansi-blue-fg">=</span> DataWrapper<span class="ansi-blue-fg">.</span>from_pandas<span class="ansi-blue-fg">(</span>pd<span class="ansi-blue-fg">.</span>DataFrame<span class="ansi-blue-fg">(</span>test_x<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> pd<span class="ansi-blue-fg">.</span>Series<span class="ansi-blue-fg">(</span>test_y<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     11</span> 
<span class="ansi-green-intense-fg ansi-bold">     12</span> test_node <span class="ansi-blue-fg">=</span> Node<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> np<span class="ansi-blue-fg">.</span>arange<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">7</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;DataWrapper&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="best_split" class="doc_header"><code>best_split</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/models.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>best_split</code>(<strong><code>data</code></strong>, <strong><code>node</code></strong>, <strong><code>col_idxs</code></strong>, <strong><code>min_leaf_samples</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<span class="n">best_split</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_node</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">test_split</span>
<span class="k">assert</span> <span class="n">test_node</span><span class="o">.</span><span class="n">split_col_idx</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">test_node</span><span class="o">.</span><span class="n">split_preds</span> <span class="o">==</span> <span class="p">(</span><span class="mf">6.6</span><span class="p">,</span> <span class="mf">2.75</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DecisionTree" class="doc_header"><code>class</code> <code>DecisionTree</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/models.py#L46" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DecisionTree</code>(<strong><code>data</code></strong>, <strong><code>max_depth</code></strong>=<em><code>None</code></em>, <strong><code>min_leaf_samples</code></strong>=<em><code>3</code></em>, <strong><code>col_idxs_fn</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="print_tree" class="doc_header"><code>print_tree</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/models.py#L76" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>print_tree</code>(<strong><code>tree</code></strong>)</p>
</blockquote>
<p>print tree with splits, depth first</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">test_y</span><span class="p">)</span>
<span class="n">print_tree</span><span class="p">(</span><span class="n">DecisionTree</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">min_leaf_samples</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_tree</span><span class="p">(</span><span class="n">DecisionTree</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">min_leaf_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>TODO: xxxx clean-up</p>
<p>Might we be able to generalize better by ;</p>
<ul>
<li>adding a little randomness by using a split value that lies somewhere between the lower and upper boundary of the split. See np.random.uniform ...</li>
<li>use the average of the lower and upper boundary values</li>
</ul>
<p>both of these could be done at prediction time</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="predict_row" class="doc_header"><code>predict_row</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/models.py#L89" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>predict_row</code>(<strong><code>row</code></strong>, <strong><code>node</code></strong>)</p>
</blockquote>
<p>make a prediction for the specified row, using the specified node</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When we make a prediction for a row that was used in training and we have only 1 sample in each leaf, the tree should predict exactly the right answer</p>
<ul>
<li>grab a single row of data</li>
<li>make a prediction for this row</li>
<li>assert that the prediction we made matches the actual for this row</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_tree</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">min_leaf_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">x_rows</span><span class="p">):</span>
    <span class="n">test_sample</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">get_sample</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">predict_row</span><span class="p">(</span><span class="n">test_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="n">test_sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Set-up some data for testing. This data is copied from the final model used in <a href="https://github.com/fastai/fastai/tree/master/courses/ml1/lesson2-rf_interpretation.ipynb">https://github.com/fastai/fastai/tree/master/courses/ml1/lesson2-rf_interpretation.ipynb</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bulldozers_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;test/data/bulldozers.npy&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">DataWrapper</span><span class="p">(</span><span class="o">*</span><span class="n">bulldozers_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">DataWrapper</span><span class="p">(</span><span class="o">*</span><span class="n">bulldozers_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">valid_data</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Use a very small amount of data to train a decision tree, then print the root node so we can see how the data has been split.</p>
<p>It's interesting that the depth of this tree is greater than the expected <code>np.log2(test_tree.data.x_rows)</code> - because it's unbalanced.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_tree</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">min_leaf_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">print_tree</span><span class="p">(</span><span class="n">test_tree</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get predictions for all of the data we trained on.</p>
<p>Although we set <code>min_leaf_samples=1</code>, not every sample has it's own leaf. If 2 or more samples have;</p>
<ul>
<li>the same values for all independent variables and</li>
<li>different values for the dependent variable,</li>
<li>they will end up in the same leaf (because we can't find a value to split on) that will predict the mean of the dependent variables for all samples in the leaf</li>
</ul>
<p>So we expect preds to be nearly 100% correct;</p>
<ul>
<li>loss to be nearly zero</li>
<li>predictions vs actual plots a strait line with just a little variation</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_tree</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span> <span class="n">min_leaf_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">test_preds</span> <span class="o">=</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_tree</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get predictions for all of the data we trained on again - but allow a minimum of 5 items in each leaf. So we see;</p>
<ul>
<li>a non-zero loss</li>
<li>some variance in the predictions vs actual plot</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_tree</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span> <span class="n">min_leaf_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">test_preds</span> <span class="o">=</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_tree</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get predictions for the validation data - we don't expect a single tree to be very good</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_preds</span> <span class="o">=</span> <span class="n">test_tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_data</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">y</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tree-Ensemble-(AKA-Random-Forest)">Tree Ensemble (AKA Random Forest)<a class="anchor-link" href="#Tree-Ensemble-(AKA-Random-Forest)">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TreeEnsemble" class="doc_header"><code>class</code> <code>TreeEnsemble</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/models.py#L99" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TreeEnsemble</code>(<strong><code>data</code></strong>, <strong><code>sample_size</code></strong>, <strong><code>max_depth</code></strong>=<em><code>None</code></em>, <strong><code>min_leaf_samples</code></strong>=<em><code>3</code></em>, <strong><code>n_trees</code></strong>=<em><code>10</code></em>, <strong><code>col_idxs_fn</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create a tree ensemble and check that it has initialized correctly</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_ensemble</span> <span class="o">=</span> <span class="n">TreeEnsemble</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">min_leaf_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">test_ensemble</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">==</span> <span class="mi">750</span> <span class="o">==</span> <span class="n">test_ensemble</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">x_rows</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_ensemble</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_ensemble</span><span class="o">.</span><span class="n">col_idxs_fn</span><span class="p">(</span><span class="n">test_ensemble</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">all_x_col_idxs</span><span class="p">))</span> <span class="o">==</span> <span class="mi">9</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_ensemble</span><span class="o">.</span><span class="n">trees</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Fit the ensemble and get predictions for all of the data we trained on - TODO: I'd expect this to be better than a single tree but the loss is the same.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_ensemble</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">test_preds</span> <span class="o">=</span> <span class="n">test_ensemble</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_ensemble</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_ensemble</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">test_ensemble</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get predictions for the validation data - expect this to be better than a single tree.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_preds</span> <span class="o">=</span> <span class="n">test_ensemble</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_data</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">y</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>TODO</p>
<ul>
<li>add classification capability</li>
</ul>
<ul>
<li>confidence based on tree pred variance</li>
<li>feature importance<ul>
<li>jumble single column -&gt; create preds - which column makes preds the worst when jumbled</li>
<li>WHAT are you forgetting?<ul>
<li>is it which split/feature contributes the biggest change from "bias" to "pred"</li>
</ul>
</li>
<li>avg depth of feature in tree &lt;- i just made this up</li>
</ul>
</li>
<li>show dendogram of rank correlation</li>
<li>partial dependence<ul>
<li>ggplot if monotonic relationship</li>
<li>do the "what if" preds - i.e. change year of sale to 1960 and see what things would have sold for</li>
<li>pdp plot</li>
</ul>
</li>
<li>tree interpret<ul>
<li>for single row pred: print contribution of each split (feature) to final result</li>
<li>waterfall chart</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
</div>
 

