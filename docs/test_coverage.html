---

title: Creating code coverage reports for an nbdev project

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 80_test_coverage.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Overview-of-this-module">Overview of this module<a class="anchor-link" href="#Overview-of-this-module"> </a></h1><p><strong>Note: This is probably not the best way to get coverage - but I'm leaving this content in case it's useful</strong></p>
<p><strong>Note:</strong> Until the next <code>nbdev</code> release you need to use an <a href="https://github.com/fastai/nbdev/#installing">editable install</a>, as this module uses new functions like <code>split_flags_and_code</code>.</p>
<p>Feel free to use <code>pytest</code> etc but to follow these examples, you'll just need <code>coverage</code>.</p>
<p>This notebook creates <code>testcoverage.py</code> which is not tied to the decision_tree project (so you can just download <a href="https://github.com/pete88b/decision_tree/blob/master/decision_tree/testcoverage.py">testcoverage.py</a> if you like)</p>
<p>Running <code>testcoverage.py</code> will:</p>
<ul>
<li>create a new folder in your nbdev project <code>[lib_path]_test</code></li>
<li>delete all test scripts in <code>[lib_path]_test</code></li>
<li>write a test script to <code>[lib_path]_test</code> for each notebook in <code>[nbs_path]</code><ul>
<li>and a <code>run_all.py</code> to run all test scripts in one go</li>
</ul>
</li>
</ul>
<p>To run create a test coverage report:</p>
<ul>
<li>cd to <code>nbs_path</code> of the project you want to test</li>
<li>create test scripts with <code>python [full path ...]/testcoverage.py</code> </li>
<li><code>coverage run --source=[lib_path] [lib_path]_test/run_all.py</code></li>
<li><code>coverage report</code></li>
</ul>
<p>Creating a test coverage report for fastai2 in my env looks like:</p>

<pre><code>cd /home/peter/github/pete88b/fastai2/nbs

python /home/peter/github/pete88b/decision_tree/decision_tree/testcoverage.py

coverage run --source=/home/peter/github/pete88b/fastai2/fastai2 /home/peter/github/pete88b/fastai2/fastai2_test/run_all.py

coverage report</code></pre>
<p><em>Note: this &uarr; fails very quickly as fastai2 tests use things that are not available in plain python.</em></p>
<h2 id="What-next?">What next?<a class="anchor-link" href="#What-next?"> </a></h2><ul>
<li>see if running tests in plain python is useful<ul>
<li>it might be true that the tests of some/most projects don't need any ipython</li>
</ul>
</li>
<li>make artifacts (like images/mnist3.png) available to the test scripts<ul>
<li>so you don't have to be in the nbs folder to run tests</li>
</ul>
</li>
<li>see if we can get coverage when running tests with ipython<ul>
<li>this looks promising <a href="https://github.com/computationalmodelling/nbval">https://github.com/computationalmodelling/nbval</a></li>
</ul>
</li>
<li>see if there is a nice way to separate plain python tests and ipython tests?</li>
</ul>
<h2 id="Details-details-...">Details details ...<a class="anchor-link" href="#Details-details-..."> </a></h2><p>I chose to "import" the module being tested (rather than write all code cells to the test script) so that:</p>
<ul>
<li>we are testing the library created by nbdev<ul>
<li>because the things we deliver are .py files, I can't help thinking that these are what we should be testing</li>
</ul>
</li>
<li>we could use the test scripts to test a pip installed version of the library<ul>
<li>i.e. we are testing the result of the full build, package and delivery process</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="write_imports" class="doc_header"><code>write_imports</code><a href="__main__.py#L2" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>write_imports</code>(<strong><code>test_file</code></strong>, <strong><code>exports</code></strong>)</p>
</blockquote>
<p>write import statements to the test script for all modules exported to by the nb we're converting</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>the test scipt will import everything returned by <code>dir(module)</code> because we need the test code to run as if it's in the module we're testing</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="write_test_cell_callback" class="doc_header"><code>write_test_cell_callback</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/testcoverage.py#L25" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>write_test_cell_callback</code>(<strong><code>i</code></strong>, <strong><code>cell</code></strong>, <strong><code>export</code></strong>, <strong><code>code</code></strong>)</p>
</blockquote>
<p>Return the code to be written to the test script or <code>None</code> to not write anything for <code>cell</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="write_test_cells" class="doc_header"><code>write_test_cells</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/testcoverage.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>write_test_cells</code>(<strong><code>test_file</code></strong>, <strong><code>nb</code></strong>, <strong><code>exports</code></strong>)</p>
</blockquote>
<p>Writes the source of code cells to the test script</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="notebook2testscript" class="doc_header"><code>notebook2testscript</code><a href="https://github.com/pete88b/decision_tree/tree/master/decision_tree/testcoverage.py#L46" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>notebook2testscript</code>()</p>
</blockquote>
<p>Convert notebooks to test scripts</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="PB-notes">PB notes<a class="anchor-link" href="#PB-notes"> </a></h1><ul>
<li>convert all notebooks that don't start with <code>_</code> <ul>
<li>import default_export of notebook</li>
<li>import things exported to other modules </li>
<li>handle nbdev test flags - TODO</li>
<li>create <code>test_[notebook name].py</code></li>
<li>write code of test cells to <code>test_[notebook name].py</code><ul>
<li>exclude show_doc, notebook2script, cmd calls etc TODO</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>coverage run --source=/home/peter/github/pete88b/decision_tree/decision_tree /home/peter/github/pete88b/decision_tree/decision_tree_test/test_00_core.py

coverage run --source=/home/peter/github/pete88b/decision_tree/decision_tree /home/peter/github/pete88b/decision_tree/decision_tree_test/run_all.py</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>cd /home/peter/github/pete88b/decision_tree

python /home/peter/github/pete88b/decision_tree/decision_tree/testcoverage.py

coverage run --source=/home/peter/github/pete88b/decision_tree/decision_tree /home/peter/github/pete88b/decision_tree/decision_tree_test/run_all.py

coverage report</code></pre>

</div>
</div>
</div>
</div>
 

